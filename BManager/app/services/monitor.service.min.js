"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var order_filter_object_1=require("../objects/order/order.filter.object"),date_helper_1=require("../helpers/date.helper"),order_constants_1=require("../constants/order.constants"),db_messages_constants_1=require("../constants/db.messages.constants"),monitor_order_row_object_1=require("../objects/monitor/monitor.order.row.object"),callback_service_interface_1=require("../interfaces/callback.service.interface"),MonitorService=function(_super){function MonitorService(orderService,confService,$q,$interval){var _this=_super.call(this,$interval)||this;return _this.orderService=orderService,_this.confService=confService,_this.$q=$q,_this.cacheData={},_this}return __extends(MonitorService,_super),MonitorService.prototype.getActiveMonitorOrdersRows=function(){return this.getActiveOrders().then(function(orders){return MonitorService.OrdersToMonitorRows(orders)})},MonitorService.prototype.getActiveOrders=function(){var _this=this,hoursInterval=this.confService.configurationData.monitorActiveOrderHours,toDate=date_helper_1.DateHelper.GetTodayDate(hoursInterval);return this.orderService.getOrders(order_filter_object_1.OrderFilterObject.GetActiveOrdersFilter(toDate)).then(function(orders){return _this.timestamp=Date.now(),_this.cacheData.monitorOrdersCount=orders?orders.length:0,orders})},MonitorService.prototype.getPreviousOrderVersion=function(order){return this.orderService.getPreviousOrderVersion(order)},MonitorService.prototype.updateOrderStatus=function(order,newStatus){return this.orderService.updateOrderStatus(order,newStatus).then(function(dbMsg){return dbMsg.code===db_messages_constants_1.DbMessagesConstants.CODE_OK})},MonitorService.prototype.updateOrderRowStatus=function(orderRow,newStatus){return this.orderService.updateOrderRowStatus(orderRow,newStatus).then(function(dbMsg){return dbMsg.code===db_messages_constants_1.DbMessagesConstants.CODE_OK})},MonitorService.prototype.updateOrderNote=function(order,newNote){return this.orderService.updateOrderNote(order,newNote).then(function(dbMsg){return dbMsg.code===db_messages_constants_1.DbMessagesConstants.CODE_OK})},MonitorService.prototype.updateOrderRowNote=function(orderRow,newNote){return this.orderService.updateOrderRowNote(orderRow,newNote).then(function(dbMsg){return dbMsg.code===db_messages_constants_1.DbMessagesConstants.CODE_OK})},MonitorService.prototype.monitorOrderRowStart=function(monitorOrderRow){var actionPromise,_this=this;monitorOrderRow.orderRow&&monitorOrderRow.order&&(actionPromise=this.updateOrderRowStatus(monitorOrderRow.orderRow,order_constants_1.OrderConstants.STATUS_IN_PROGRESS).then(function(result){return result&&(monitorOrderRow.orderRow.status=order_constants_1.OrderConstants.STATUS_IN_PROGRESS),result}).then(function(result){if(result&&monitorOrderRow.order.status!==order_constants_1.OrderConstants.STATUS_IN_PROGRESS)return _this.updateOrderStatus(monitorOrderRow.order,order_constants_1.OrderConstants.STATUS_IN_PROGRESS).then(function(result){result&&(monitorOrderRow.order.status=order_constants_1.OrderConstants.STATUS_IN_PROGRESS)})}));return this.$q.when(actionPromise).then(function(result){}).catch(function(error){})},MonitorService.prototype.monitorOrderRowReady=function(monitorOrderRow){var actionPromise,_this=this;monitorOrderRow.orderRow&&monitorOrderRow.order&&(actionPromise=this.updateOrderRowStatus(monitorOrderRow.orderRow,order_constants_1.OrderConstants.STATUS_READY).then(function(result){return result&&(monitorOrderRow.orderRow.status=order_constants_1.OrderConstants.STATUS_READY),result}).then(function(result){if(result&&monitorOrderRow.order.isReady)return _this.updateOrderStatus(monitorOrderRow.order,order_constants_1.OrderConstants.STATUS_READY).then(function(result){result&&(monitorOrderRow.order.status=order_constants_1.OrderConstants.STATUS_READY)})}));return this.$q.when(actionPromise).then(function(result){}).catch(function(error){})},MonitorService.OrdersToMonitorRows=function(orders){for(var rows=[],i=0;i<orders.length;i++)for(var j=0;j<orders[i].orderRows.length;j++)rows.push(new monitor_order_row_object_1.MonitorOrderRowObject(orders[i],orders[i].orderRows[j]));return rows},MonitorService}(callback_service_interface_1.CallbackService);exports.MonitorService=MonitorService;